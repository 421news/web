# 421.news - Ghost Theme Project

## Overview
Ghost CMS theme for **421.news**, a bilingual (ES/EN) blog about culture, gaming, tech, and real life. The site runs on Ghost Pro at `421bn.ghost.io` (public URL: `www.421.news`).

## Credentials

- **Ghost Admin API Key**: `GHOST_ADMIN_API_KEY_REDACTED`
- **Ghost Content API Key**: `420da6f85b5cc903b347de9e33`
- **Ghost instance**: `421bn.ghost.io` (redirects to `www.421.news`)
- **GitHub repo**: `https://github.com/421news/web.git` (branch: `main`)

## Deploy Workflow

1. Edit files
2. Bump version in `package.json`
3. Zip (excluding `.git/`, `node_modules/`, `.github/`, `scripts/`)
4. Upload via Ghost Admin API (`POST /ghost/api/admin/themes/upload/`)
5. Activate via Admin API (`PUT /ghost/api/admin/themes/421-theme/activate/`)
6. Auth: JWT signed with HMAC-SHA256 using the Admin API key

Quick deploy with Node.js (from project root):
```js
const jwt = require('jsonwebtoken');
const [id, secret] = 'ADMIN_KEY'.split(':');
const token = jwt.sign({}, Buffer.from(secret, 'hex'), {
  keyid: id, algorithm: 'HS256', expiresIn: '5m', audience: '/admin/'
});
// Then POST multipart form with zip to /ghost/api/admin/themes/upload/
// Then PUT to /ghost/api/admin/themes/421-theme/activate/
```

## File Structure

### Root templates (pages)
- `default.hbs` - Main layout. Loads Google Fonts (Nunito Sans + Lora), WebFont loader, global CSS
- `index.hbs` - Spanish homepage
- `en.hbs` - English homepage
- `post.hbs` - Post router: checks `#en` tag to pick `post-en.hbs` or `post-es.hbs`
- `page.hbs` - Static pages. Has `{{#page}}` context for title/feature_image
- `tag.hbs` - Tag listing page
- `tags.hbs` - All tags page
- `author.hbs` - Author page
- `error-404.hbs` - 404 page
- `tag-*.hbs` - Custom templates per tag (cultura, juegos, tech, vida-real, etc.)
- `tag-secundario-*.hbs` - Secondary tag templates
- `subscribe.hbs` / `suscribite.hbs` - Subscription pages (EN/ES)

### Partials (`partials/`)
- **`post-es.hbs`** - Spanish post template. Contains article body, author box, related posts query, file browser
- **`post-en.hbs`** - English post template. Same structure as post-es but with EN text and `hash-en` filters
- `post-card.hbs` - Post card component (used in grids). Has hover effect with texture overlay
- `post-header.hbs` / `featured-post-header.hbs` - Post header with feature image
- `site-nav-es.hbs` / `site-nav-en.hbs` - Navigation bars
- `site-footer.hbs` - Footer
- `file-browser.hbs` / `file-browser-en.hbs` - File browser navigation component
- `general-styling.hbs` - Inline style partial (CSS variables, etc.)
- `reading-progress-bar.hbs` - Reading progress bar component
- `index-featured-post.hbs` / `index-featured-post-mobile.hbs` - Featured post on homepage
- `index-highlighted-posts-es.hbs` / `index-highlighted-posts-en.hbs` - Highlighted posts grids
- `last-posts-*.hbs` - Latest posts sections
- `tag-preview-section.hbs` - Tag preview sections
- `window-manager.hbs` - Desktop-style window manager UI component

### CSS (`assets/css/`)
- **`index.css`** - Main custom CSS. All theme overrides go here:
  - Gallery breakout (1200px max, center with transform)
  - Bookmark card thumbnail gap fix
  - Header card centering
  - HR gradient divider (`linear-gradient(280deg, var(--verde), var(--amarillo))`)
  - Link styling (gradient text, no double underline from `<u>` tags)
  - Caption link gradient
  - Rich text: Lora serif font, line-height 1.5, figcaption 15px
  - h2/h3: Nunito Sans, margin-top 4rem, margin-bottom 1.5rem
  - Blockquote gradient border
  - Page hero (no borders)
- `globals.css` - CSS variables (`--verde`, `--amarillo`, etc.)
- `site-nav.css` - Navigation styles
- `file-browser.css` - File browser styles
- `window-manager.css` - Window manager styles
- `progress-bar.css` - Reading progress bar
- `suscribite.css` - Subscription page styles
- `webflow.css` / `udesly-ghost.css` - Base framework styles (don't edit)
- `normalize.css` - CSS reset
- `404.css` - 404 page styles

### JavaScript (`assets/js/`)
- **`related-posts.js`** - Client-side semantic related posts. Loads `related-posts.json`, fetches related posts from Content API, renders cards replacing the Handlebars fallback
- `file-browser.js` - File browser navigation logic
- `window-manager.js` - Desktop-style window manager
- `reading-progress.js` - Reading progress bar
- `hide-show-nav.js` - Scroll-based nav visibility
- `pagination-home.js` / `pagination-next.js` - Pagination logic
- `audio-effect.js` - Audio effects
- `seamless.js` - Seamless scrolling
- `udesly-ghost.min.js` - Framework JS (don't edit)

### Data (`assets/data/`)
- **`related-posts.json`** - Semantic related posts mapping. Keys = post slugs, values = arrays of 4 related post slugs. Generated by `scripts/update-related.py`

### Scripts (`scripts/`)
- **`update-related.py`** - Regenerates `related-posts.json` and uploads/activates the theme. Run: `python3 scripts/update-related.py`. Requires `scikit-learn` (`pip3 install scikit-learn`)
- `compute-related.js` - Older Node.js version (deprecated, use the Python script)

### Other
- `server.js` - Express dev server with mock data for local preview
- `routes.yaml` - Ghost routing configuration
- `package.json` - Theme metadata and version
- `layouts/default.hbs` - Express layout (dev server only)

## Bilingual System

Posts are tagged with internal tags `#es` (slug: `hash-es`) or `#en` (slug: `hash-en`). The `post.hbs` template checks this tag and routes to either `post-es.hbs` or `post-en.hbs`. Each language has its own:
- Navigation (`site-nav-es` / `site-nav-en`)
- File browser (`file-browser` / `file-browser-en`)
- Footer text
- Related posts query (filtered by `tag:hash-es` or `tag:hash-en`)

## Related Posts System

Two layers:

1. **Handlebars (server-side, instant)**: `{{#get "posts"}}` query in `post-es.hbs`/`post-en.hbs` matches by `primary_tag` + language. Falls back to any recent posts in the same language if no match.

2. **JavaScript (client-side, semantic)**: `related-posts.js` loads `related-posts.json`, looks up the current post's slug, fetches the 4 related posts via Content API, and replaces the Handlebars-rendered cards. If the slug isn't in the JSON (new post), the Handlebars version stays.

The JSON is generated by TF-IDF + cosine similarity with a semantic concept expansion layer (CONCEPT_MAP in the Python script) that bridges related topics (e.g., "pokemon" -> anime, manga, tcg, videogame).

**To update after publishing new posts**: `python3 scripts/update-related.py`

## Key CSS Variables (from globals.css)

- `--verde` - Green accent color
- `--amarillo` - Yellow/gold accent color
- Used in gradients: `linear-gradient(280deg, var(--verde), var(--amarillo))`

## Ghost-specific Notes

- `{{#get}}` queries use NQL (Ghost Query Language) for filters
- `{{#foreach}}` inside `{{#get}}` filter attributes does NOT work - generates invalid NQL
- `{{#get}}`'s own `{{else}}` properly detects 0 results (unlike `{{#if variable}}` on empty arrays)
- `{{asset "path"}}` resolves to `/assets/path?v=HASH`
- `{{#page}}` context is required to access page fields in `page.hbs`
- Ghost's `cards.min.css` has high-specificity rules for `.kg-*` classes that need to be overridden carefully
- Internal tags (starting with `#`) are excluded from `primary_tag`
