{{!< default}}

    <link href="{{asset "css/suscribite.css"}}" rel="stylesheet" type="text/css">
    <div class="page-wrapper">
      {{> "general-styling"}}
      {{> "site-nav-es"}}

      <div class="sub-page">
        <div class="sub-container">

          <!-- ===== SECTION 1: HERO + PLAN ===== -->
          <div id="sub-section-plan">

            <div class="sub-hero">
              <h1 class="sub-hero-title">Sumate!</h1>
              <p class="sub-hero-subtitle">421 es un medio de orientaci&oacute;n intelectual para navegar un mundo saturado de tecnolog&iacute;a, im&aacute;genes y discursos. Nuestro objetivo es ayudarte a navegar mejor en un mundo que te pasa por arriba.</p>
              <p class="sub-hero-callout">Tu aporte econ&oacute;mico es esencial para la subsistencia del proyecto.</p>
            </div>
            <hr class="sub-gradient-divider">

            <div class="sub-card" id="sub-plan-card">
              <div class="plan-toggle">
                <button class="plan-toggle-btn" id="toggle-monthly">Mensual</button>
                <button class="plan-toggle-btn active" id="toggle-yearly">
                  Anual
                  <span class="toggle-badge">-17%</span>
                </button>
              </div>

              <div id="plan-price">
                <div class="plan-price-row">
                  <span class="plan-price-big" id="price-amount">...</span>
                  <span class="plan-price-period" id="price-period">USD / a&ntilde;o</span>
                </div>
                <div class="plan-price-detail" id="price-detail"></div>
              </div>

              <ul class="plan-benefits">
                <li>Newsletter mensual premium</li>
                <li>Edici&oacute;n digital de la Revista 421</li>
                <li>Acceso anticipado a notas</li>
                <li>Invitaciones a eventos AFK</li>
                <li>Participaci&oacute;n en la comunidad de Wizards</li>
              </ul>

              <button class="btn-gradient" id="btn-suscribirme">Suscribirme</button>
            </div>

            <div class="free-tier-link">
              <p>&iquest;Solo quer&eacute;s recibir las notas por mail?</p>
              <button class="btn-outline" id="btn-free">Registrate gratis</button>
            </div>
          </div>

          <!-- ===== SECTION 2: PAYMENT METHOD CHOOSER ===== -->
          <div id="sub-section-chooser" style="display: none;">

            <div class="sub-hero">
              <h1 class="sub-hero-title">Eleg&iacute; c&oacute;mo pagar</h1>
            </div>
            <hr class="sub-gradient-divider">

            <div class="sub-card" style="max-width: 600px;">
              <div class="sub-card-label" id="chooser-plan-name"></div>

              <div class="payment-methods">
                <button class="payment-method-btn" id="btn-stripe">
                  <span class="payment-method-icon">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                      <rect width="40" height="40" rx="8" fill="#635BFF"/>
                      <path d="M18.5 16.5c0-.83.68-1.15 1.81-1.15 1.62 0 3.67.49 5.29 1.37V11.8c-1.77-.7-3.52-.98-5.29-.98-4.33 0-7.21 2.26-7.21 6.04 0 5.89 8.11 4.95 8.11 7.49 0 .98-.85 1.3-2.05 1.3-1.77 0-4.04-.73-5.83-1.71v4.98c1.98.85 3.99 1.22 5.83 1.22 4.43 0 7.48-2.19 7.48-6.02-.02-6.36-8.14-5.23-8.14-7.62z" fill="white"/>
                    </svg>
                  </span>
                  <span class="payment-method-name">Stripe</span>
                  <span class="payment-method-desc">Tarjeta internacional (USD)</span>
                </button>

                <button class="payment-method-btn" id="btn-mp">
                  <span class="payment-method-icon">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                      <rect width="40" height="40" rx="8" fill="#009EE3"/>
                      <path d="M28.5 18.5c0-4.14-3.36-6-7.5-6-4.14 0-8 2.36-8 7s3.36 8.5 8 8.5c3.14 0 5.5-1.36 6.5-3" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                      <circle cx="21" cy="19.5" r="2" fill="white"/>
                    </svg>
                  </span>
                  <span class="payment-method-name">MercadoPago</span>
                  <span class="payment-method-desc">Pesos argentinos (d&oacute;lar blue)</span>
                </button>
              </div>

              <p class="payment-method-note">
                Stripe cobra en USD. MercadoPago pesifica al d&oacute;lar blue de hoy.
              </p>
            </div>

            <button class="btn-back" id="btn-back-plan">&larr; Volver a planes</button>
          </div>

          <!-- ===== SECTION 3: MERCADOPAGO FORM ===== -->
          <div id="sub-section-mp" style="display: none;">

            <div class="sub-hero">
              <h1 class="sub-hero-title">Complet&aacute; tu suscripci&oacute;n</h1>
            </div>
            <hr class="sub-gradient-divider">

            <div class="sub-card">
              <div class="sub-card-label" id="mp-plan-name"></div>

              <form id="mp-form">
                <input type="hidden" id="mp-sub-type" value="">
                <div class="form-group">
                  <label for="mp-name">Nombre completo</label>
                  <input type="text" id="mp-name" name="name" required placeholder="Tu nombre">
                </div>
                <div class="form-group">
                  <label for="mp-email">Correo electr&oacute;nico</label>
                  <input type="email" id="mp-email" name="email" required placeholder="tu@email.com">
                </div>
                <p class="form-note">El mail tiene que ser el mismo de la cuenta de MercadoPago.</p>
                <button type="submit" class="btn-solid" id="mp-submit-btn">Ir a MercadoPago</button>
              </form>
              <div id="mp-form-message" class="form-message"></div>
            </div>

            <button class="btn-back" id="btn-back-chooser">&larr; Cambiar m&eacute;todo de pago</button>
          </div>

        </div>
      </div>

      {{> "site-footer"}}
    </div>

    <script defer>
      document.addEventListener('DOMContentLoaded', function() {
        // State
        var currentCadence = 'yearly';
        var tierData = null;

        // DOM refs
        var sectionPlan = document.getElementById('sub-section-plan');
        var sectionChooser = document.getElementById('sub-section-chooser');
        var sectionMp = document.getElementById('sub-section-mp');

        // Fetch tiers from Content API
        fetch('/ghost/api/content/tiers/?key=420da6f85b5cc903b347de9e33')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var tiers = data.tiers || [];
            for (var i = 0; i < tiers.length; i++) {
              if (tiers[i].type === 'paid' && tiers[i].active) {
                tierData = tiers[i];
                break;
              }
            }
            if (tierData) updatePriceDisplay();
          });

        function formatPrice(cents) {
          var dollars = cents / 100;
          return '$' + (dollars % 1 === 0 ? dollars : dollars.toFixed(2));
        }

        function updatePriceDisplay() {
          if (!tierData) return;
          var amountEl = document.getElementById('price-amount');
          var periodEl = document.getElementById('price-period');
          var detailEl = document.getElementById('price-detail');

          if (currentCadence === 'yearly') {
            amountEl.textContent = formatPrice(tierData.yearly_price);
            periodEl.textContent = 'USD / a\u00f1o';
            var monthlyTotal = tierData.monthly_price * 12;
            detailEl.innerHTML = '<span class="striked">' + formatPrice(monthlyTotal) + '</span> \u2014 ahorra 2 meses';
          } else {
            amountEl.textContent = formatPrice(tierData.monthly_price);
            periodEl.textContent = 'USD / mes';
            detailEl.textContent = 'Sin compromiso, cancela cuando quieras';
          }
        }

        function showSection(section) {
          sectionPlan.style.display = 'none';
          sectionChooser.style.display = 'none';
          sectionMp.style.display = 'none';
          section.style.display = 'block';
          window.scrollTo(0, 0);
        }

        function getPlanLabel() {
          if (!tierData) return '';
          if (currentCadence === 'yearly') {
            return 'Wizard Anual \u2014 ' + formatPrice(tierData.yearly_price) + ' USD/a\u00f1o';
          }
          return 'Wizard Mensual \u2014 ' + formatPrice(tierData.monthly_price) + ' USD/mes';
        }

        // Toggle monthly/yearly
        var toggleM = document.getElementById('toggle-monthly');
        var toggleY = document.getElementById('toggle-yearly');

        toggleM.addEventListener('click', function() {
          currentCadence = 'monthly';
          toggleM.classList.add('active');
          toggleY.classList.remove('active');
          updatePriceDisplay();
        });

        toggleY.addEventListener('click', function() {
          currentCadence = 'yearly';
          toggleY.classList.add('active');
          toggleM.classList.remove('active');
          updatePriceDisplay();
        });

        // Suscribirme → show payment chooser
        document.getElementById('btn-suscribirme').addEventListener('click', function() {
          document.getElementById('chooser-plan-name').textContent = getPlanLabel();
          showSection(sectionChooser);
        });

        // Free signup → Ghost Portal
        document.getElementById('btn-free').addEventListener('click', function() {
          window.location.hash = '#/portal/signup/free';
        });

        // Stripe → Ghost Portal with tier
        document.getElementById('btn-stripe').addEventListener('click', function() {
          if (!tierData) return;
          window.location.hash = '#/portal/signup/' + tierData.id + '/' + currentCadence;
        });

        // MercadoPago → show form
        document.getElementById('btn-mp').addEventListener('click', function() {
          document.getElementById('mp-plan-name').textContent = getPlanLabel() + ' \u2014 MercadoPago';
          document.getElementById('mp-sub-type').value = currentCadence === 'yearly' ? 'wizard-yearly' : 'wizard-monthly';
          showSection(sectionMp);
        });

        // Back buttons
        document.getElementById('btn-back-plan').addEventListener('click', function() {
          showSection(sectionPlan);
        });
        document.getElementById('btn-back-chooser').addEventListener('click', function() {
          showSection(sectionChooser);
        });

        // MP form submit
        document.getElementById('mp-form').addEventListener('submit', function(e) {
          e.preventDefault();
          var msg = document.getElementById('mp-form-message');
          var btn = document.getElementById('mp-submit-btn');
          msg.textContent = 'Procesando...';
          msg.className = 'form-message';
          btn.disabled = true;
          btn.textContent = 'Procesando...';

          fetch('https://mercadopago-ghost.onrender.com/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              formSubType: document.getElementById('mp-sub-type').value,
              formName: document.getElementById('mp-name').value,
              formEmail: document.getElementById('mp-email').value
            })
          })
          .then(function(r) {
            if (!r.ok) throw new Error('Error del servidor');
            return r.json();
          })
          .then(function(data) {
            if (data.success && data.redirectUrl) {
              window.location.href = data.redirectUrl;
            } else {
              throw new Error(data.message || 'Error al procesar');
            }
          })
          .catch(function(err) {
            msg.textContent = 'Error al procesar la suscripci\u00f3n. Intent\u00e1 nuevamente.';
            msg.className = 'form-message error';
            btn.disabled = false;
            btn.textContent = 'Ir a MercadoPago';
          });
        });
      });
    </script>
