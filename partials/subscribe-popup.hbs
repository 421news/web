{{#unless @member}}
<div id="sub-popup" class="sub-popup" style="display:none;">
  <div class="sub-popup-backdrop"></div>
  <div class="sub-popup-card">
    <button class="sub-popup-close" aria-label="Cerrar">&times;</button>
    <div class="sub-popup-header">
      <img class="sub-popup-cover" src="https://www.421.news/content/images/2026/02/11_diciembre.jpg" alt="Revista 421 #11" width="90" height="127" loading="lazy">
      <div class="sub-popup-header-text">
        <span class="sub-popup-badge">{{#has tag="#en"}}FREE DOWNLOAD{{else}}DESCARGA GRATIS{{/has}}</span>
        <h3 class="sub-popup-title">Revista 421 #11</h3>
        <p class="sub-popup-subtitle">{{#has tag="#en"}}Special: Autonomy{{else}}Especial: Autonom&iacute;a{{/has}}</p>
      </div>
    </div>
    <p class="sub-popup-text">{{#has tag="#en"}}Join 4,000+ readers. Get our digital magazine free and access to everything we publish.{{else}}Sum&aacute;te a los 4.000+ lectores. Descarg&aacute; la revista digital gratis y acced&eacute; a todo lo que publicamos.{{/has}}</p>
    <a href="https://storage.ghost.io/c/2b/7f/2b7f69fc-a243-4d2f-ae8e-db8312c6653a/content/files/2026/02/Revista-421--11--enero-2026-.pdf" class="sub-popup-btn sub-popup-btn-primary" target="_blank" rel="noopener" data-popup-action="download">{{#has tag="#en"}}Download free PDF{{else}}Descargar PDF gratis{{/has}}</a>
    <a href="{{#has tag="#en"}}/en/subscribe/{{else}}/es/suscribite/{{/has}}" class="sub-popup-btn sub-popup-btn-secondary" data-popup-action="subscribe">{{#has tag="#en"}}See all plans{{else}}Ver todos los planes{{/has}}</a>
    <button class="sub-popup-later">{{#has tag="#en"}}Maybe later{{else}}Ahora no{{/has}}</button>
  </div>
</div>

<style>
.sub-popup { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; }
.sub-popup-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
.sub-popup-card {
  position: relative;
  max-width: 420px;
  width: 90%;
  background: rgba(18, 18, 18, 0.92);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid rgba(234,230,225,0.12);
  border-radius: var(--radius);
  padding: 2rem 1.8rem 1.5rem;
  text-align: center;
  animation: subPopupIn 0.35s ease;
}
@keyframes subPopupIn {
  from { opacity: 0; transform: translateY(20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.sub-popup-close {
  position: absolute; top: 10px; right: 12px;
  background: none; border: none; color: var(--crema); opacity: 0.4;
  font-size: 24px; cursor: pointer; line-height: 1; transition: opacity 0.2s;
}
.sub-popup-close:hover { opacity: 1; }
.sub-popup-header {
  display: flex; align-items: center; gap: 1rem;
  margin-bottom: 1rem; text-align: left;
}
.sub-popup-cover {
  width: 90px; height: auto; border-radius: 4px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  flex-shrink: 0;
}
.sub-popup-header-text { flex: 1; }
.sub-popup-badge {
  display: inline-block;
  font-size: var(--fs-2xs); font-weight: 800; letter-spacing: 0.08em;
  background: linear-gradient(280deg, var(--verde), var(--amarillo));
  color: var(--negro);
  padding: 3px 8px; border-radius: 3px;
  margin-bottom: 6px;
}
.sub-popup-title {
  font-size: var(--fs-xl); font-weight: 800; font-style: italic;
  background: linear-gradient(280deg, var(--verde), var(--amarillo));
  -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
  margin: 0 0 2px; line-height: 1.2;
}
.sub-popup-subtitle {
  font-family: 'Lora', serif; font-style: italic;
  font-size: var(--fs-base); color: var(--crema); opacity: 0.6;
  margin: 0;
}
.sub-popup-text {
  font-family: 'Lora', serif; font-style: italic;
  font-size: var(--fs-base); color: var(--crema); opacity: 0.7;
  line-height: 1.55; margin: 0 0 1.2rem;
}
.sub-popup-btn {
  display: block; width: 100%; padding: 12px;
  border: none; border-radius: 6px;
  font-weight: 700; font-size: var(--fs-base);
  text-decoration: none; text-align: center;
  font-family: inherit; cursor: pointer; transition: opacity 0.2s;
}
.sub-popup-btn:hover { opacity: 0.9; }
.sub-popup-btn-primary {
  background: linear-gradient(280deg, var(--verde), var(--amarillo));
  color: var(--negro);
  margin-bottom: 0.5rem;
}
.sub-popup-btn-secondary {
  background: transparent;
  border: 1px solid rgba(234,230,225,0.2);
  color: var(--crema);
}
.sub-popup-btn-secondary:hover { border-color: rgba(234,230,225,0.4); }
.sub-popup-later {
  display: block; margin: 0.8rem auto 0;
  background: none; border: none; color: var(--crema); opacity: 0.35;
  font-size: var(--fs-xs); font-family: inherit; cursor: pointer; transition: opacity 0.2s;
}
.sub-popup-later:hover { opacity: 0.7; }

/* Light mode */
.light-mode .sub-popup-card { background: rgba(234, 230, 225, 0.92); border-color: rgba(0,0,0,0.1); }
.light-mode .sub-popup-close { color: var(--negro); }
.light-mode .sub-popup-text { color: var(--negro); }
.light-mode .sub-popup-subtitle { color: var(--negro); }
.light-mode .sub-popup-btn-secondary { color: var(--negro); border-color: rgba(0,0,0,0.2); }
.light-mode .sub-popup-btn-secondary:hover { border-color: rgba(0,0,0,0.4); }
.light-mode .sub-popup-later { color: var(--negro); }
</style>

<script>
(function() {
  var COOLDOWN_DAYS = 3;
  var SCROLL_TRIGGER = 0.35;
  var KEY = 'sub_popup_dismissed';

  var dismissed = localStorage.getItem(KEY);
  if (dismissed && (Date.now() - parseInt(dismissed, 10)) < COOLDOWN_DAYS * 86400000) return;

  var triggered = false;
  function onScroll() {
    if (triggered) return;
    var docHeight = document.documentElement.scrollHeight - window.innerHeight;
    if (docHeight <= 0) return;
    var pct = window.scrollY / docHeight;
    if (pct >= SCROLL_TRIGGER) {
      triggered = true;
      window.removeEventListener('scroll', onScroll);
      var popup = document.getElementById('sub-popup');
      if (popup) {
        popup.style.display = 'flex';
        if (typeof gtag === 'function') gtag('event', 'popup_shown', { event_category: 'engagement' });
      }
    }
  }

  function dismiss() {
    var popup = document.getElementById('sub-popup');
    if (popup) popup.style.display = 'none';
    localStorage.setItem(KEY, Date.now().toString());
    if (typeof gtag === 'function') gtag('event', 'popup_dismissed', { event_category: 'engagement' });
  }

  window.addEventListener('scroll', onScroll, { passive: true });

  document.addEventListener('DOMContentLoaded', function() {
    var popup = document.getElementById('sub-popup');
    if (!popup) return;
    popup.querySelector('.sub-popup-close').addEventListener('click', dismiss);
    popup.querySelector('.sub-popup-later').addEventListener('click', dismiss);
    popup.querySelector('.sub-popup-backdrop').addEventListener('click', dismiss);

    // Track CTA clicks
    var btns = popup.querySelectorAll('[data-popup-action]');
    for (var i = 0; i < btns.length; i++) {
      btns[i].addEventListener('click', function() {
        var action = this.getAttribute('data-popup-action');
        if (typeof gtag === 'function') gtag('event', 'popup_cta_click', { event_category: 'engagement', event_label: action });
        localStorage.setItem(KEY, Date.now().toString());
      });
    }
  });
})();
</script>
{{/unless}}
